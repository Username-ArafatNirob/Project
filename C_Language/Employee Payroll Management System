#include <stdio.h>
#include <stdlib.h>
#include <string.h>

struct Admin {
    char fname[20], lname[20];
    char gmail[40], phone[15];
    char username[20], password[20];
};

struct Employee {
    int id;
    char name[30];
    char designation[30];
    float salary, bonus, deduction;
    int overtime;
    float per_hour, net_salary;
};

char currentUser[20];

// ----------- Utility Functions -----------

void clearScreen() {
#ifdef _WIN32
    system("cls");
#else
    system("clear");
#endif
}

void pressEnter() {
    printf("\nPress Enter to continue...");
    getchar();
    getchar();
}

void printTitle() {
    printf("========================================\n");
    printf("      PAYROLL MANAGEMENT SYSTEM\n");
    printf("========================================\n\n");
}

// ----------- User Functions -----------

void registerUser() {
    struct Admin a, t;
    int exists = 0;
    FILE *fp;

    clearScreen();
    printTitle();

    printf("First Name: "); scanf("%s", a.fname);
    printf("Last Name : "); scanf("%s", a.lname);
    printf("Gmail     : "); scanf("%s", a.gmail);
    printf("Phone     : "); scanf("%s", a.phone);
    printf("Username  : "); scanf("%s", a.username);

    fp = fopen("users.txt", "r");
    if (fp) {
        while (fscanf(fp, "%s %s %s %s %s %s",
               t.fname, t.lname, t.gmail, t.phone,
               t.username, t.password) != EOF) {
            if (!strcmp(t.username, a.username)) {
                exists = 1;
                break;
            }
        }
        fclose(fp);
    }

    if (exists) {
        printf("\nUsername already exists!");
        pressEnter();
        return;
    }

    char confirm[20];
    printf("Password        : "); scanf("%s", a.password);
    printf("Confirm Password: "); scanf("%s", confirm);

    if (strcmp(a.password, confirm) != 0) {
        printf("\nPasswords do not match!");
        pressEnter();
        return;
    }

    fp = fopen("users.txt", "a");
    fprintf(fp, "%s %s %s %s %s %s\n",
            a.fname, a.lname, a.gmail, a.phone, a.username, a.password);
    fclose(fp);

    char empFile[40];
    sprintf(empFile, "employees_%s.txt", a.username);
    fp = fopen(empFile, "w"); fclose(fp);

    printf("\nAccount created successfully!");
    pressEnter();
}

int loginUser() {
    struct Admin a;
    char user[20], pass[20];
    FILE *fp = fopen("users.txt", "r");

    if (!fp) return 0;

    clearScreen();
    printTitle();

    printf("Username: "); scanf("%s", user);
    printf("Password: "); scanf("%s", pass);

    while (fscanf(fp, "%s %s %s %s %s %s",
           a.fname, a.lname, a.gmail, a.phone,
           a.username, a.password) != EOF) {
        if (!strcmp(user, a.username) && !strcmp(pass, a.password)) {
            strcpy(currentUser, user);
            fclose(fp);
            return 1;
        }
    }
    fclose(fp);
    return 0;
}

// ----------- Employee Functions -----------

void addEmployee() {
    struct Employee e;
    char file[40];
    sprintf(file, "employees_%s.txt", currentUser);
    FILE *fp = fopen(file, "a");

    clearScreen();
    printTitle();

    printf("Employee ID: "); scanf("%d", &e.id);
    printf("Name       : "); scanf("%s", e.name);
    printf("Designation: "); scanf("%s", e.designation);
    printf("Salary     : "); scanf("%f", &e.salary);
    printf("Bonus      : "); scanf("%f", &e.bonus);
    printf("Deduction  : "); scanf("%f", &e.deduction);
    printf("Overtime Hrs: "); scanf("%d", &e.overtime);
    printf("Per Hr Pay : "); scanf("%f", &e.per_hour);

    e.net_salary = e.salary + e.bonus + (e.overtime * e.per_hour) - e.deduction;

    fprintf(fp, "%d %s %s %.2f %.2f %.2f %d %.2f %.2f\n",
            e.id, e.name, e.designation,
            e.salary, e.bonus, e.deduction,
            e.overtime, e.per_hour, e.net_salary);

    fclose(fp);
    printf("\nEmployee added successfully!");
    pressEnter();
}

void showEmployees() {
    struct Employee e;
    char file[40];
    sprintf(file, "employees_%s.txt", currentUser);
    FILE *fp = fopen(file, "r");

    clearScreen();
    printTitle();

    if (!fp) {
        printf("No employee data found!");
        pressEnter();
        return;
    }

    printf("ID   Name      Designation  Salary   Bonus  Deduction  Overtime  PerHour  NetSalary\n");
    printf("-------------------------------------------------------------------------------\n");

    while (fscanf(fp, "%d %s %s %f %f %f %d %f %f",
           &e.id, e.name, e.designation,
           &e.salary, &e.bonus, &e.deduction,
           &e.overtime, &e.per_hour, &e.net_salary) != EOF) {

        printf("%-4d %-8s %-12s %-7.2f %-6.2f %-9.2f %-8d %-7.2f %-9.2f\n",
               e.id, e.name, e.designation, e.salary, e.bonus,
               e.deduction, e.overtime, e.per_hour, e.net_salary);
    }
    fclose(fp);
    pressEnter();
}

void searchEmployee() {
    struct Employee e;
    int id, found = 0;
    char file[40];
    sprintf(file, "employees_%s.txt", currentUser);
    FILE *fp = fopen(file, "r");

    clearScreen();
    printTitle();

    if (!fp) {
        printf("No data available!");
        pressEnter();
        return;
    }

    printf("Enter Employee ID: ");
    scanf("%d", &id);

    while (fscanf(fp, "%d %s %s %f %f %f %d %f %f",
           &e.id, e.name, e.designation,
           &e.salary, &e.bonus, &e.deduction,
           &e.overtime, &e.per_hour, &e.net_salary) != EOF) {

        if (e.id == id) {
            found = 1;
            printf("\nID: %d\nName: %s\nDesignation: %s\nSalary: %.2f\nBonus: %.2f\nDeduction: %.2f\nOvertime: %d\nPer Hour: %.2f\nNet Salary: %.2f\n",
                   e.id, e.name, e.designation,
                   e.salary, e.bonus, e.deduction,
                   e.overtime, e.per_hour, e.net_salary);
            break;
        }
    }
    fclose(fp);

    if (!found) printf("\nEmployee not found!");
    pressEnter();
}

void createNewPayroll() {
    char file[40]; sprintf(file, "employees_%s.txt", currentUser);
    int n;
    clearScreen();
    printTitle();

    printf("This will overwrite existing payroll data.\n");
    printf("Enter number of employees: ");
    scanf("%d", &n);

    FILE *fp = fopen(file, "w");

    struct Employee e;
    for (int i = 0; i < n; i++) {
        printf("\nEmployee %d\n", i+1);
        printf("ID: "); scanf("%d", &e.id);
        printf("Name: "); scanf("%s", e.name);
        printf("Designation: "); scanf("%s", e.designation);
        printf("Salary: "); scanf("%f", &e.salary);
        printf("Bonus: "); scanf("%f", &e.bonus);
        printf("Deduction: "); scanf("%f", &e.deduction);
        printf("Overtime Hrs: "); scanf("%d", &e.overtime);
        printf("Per Hr Pay : "); scanf("%f", &e.per_hour);

        e.net_salary = e.salary + e.bonus + (e.overtime*e.per_hour) - e.deduction;

        fprintf(fp, "%d %s %s %.2f %.2f %.2f %d %.2f %.2f\n",
                e.id, e.name, e.designation,
                e.salary, e.bonus, e.deduction,
                e.overtime, e.per_hour, e.net_salary);
    }

    fclose(fp);
    printf("\nPayroll created successfully!");
    pressEnter();
}

// ----------- Profile Functions -----------

void profileMenu() {
    struct Admin a, t;
    FILE *fp;

    fp = fopen("users.txt", "r");
    while (fscanf(fp, "%s %s %s %s %s %s",
           a.fname, a.lname, a.gmail,
           a.phone, a.username, a.password) != EOF) {
        if (!strcmp(a.username, currentUser)) break;
    }
    fclose(fp);

    int ch;
    while (1) {
        clearScreen();
        printTitle();
        printf("1. View Profile\n");
        printf("2. Edit Profile\n");
        printf("3. Delete Account\n");
        printf("4. Back\n");
        printf("Choose: ");
        scanf("%d", &ch);

        if (ch == 1) {
            printf("\nName: %s %s\nGmail: %s\nPhone: %s\nUsername: %s\n",
                   a.fname, a.lname, a.gmail, a.phone, a.username);
            pressEnter();
        }
        else if (ch == 2) {
            printf("New First Name: "); scanf("%s", a.fname);
            printf("New Last Name : "); scanf("%s", a.lname);
            printf("New Gmail     : "); scanf("%s", a.gmail);
            printf("New Phone     : "); scanf("%s", a.phone);

            fp = fopen("users.txt", "r");
            FILE *temp = fopen("temp.txt", "w");
            while (fscanf(fp, "%s %s %s %s %s %s",
                   t.fname, t.lname, t.gmail,
                   t.phone, t.username, t.password) != EOF) {
                if (!strcmp(t.username, currentUser))
                    fprintf(temp, "%s %s %s %s %s %s\n",
                            a.fname, a.lname, a.gmail,
                            a.phone, a.username, a.password);
                else
                    fprintf(temp, "%s %s %s %s %s %s\n",
                            t.fname, t.lname, t.gmail,
                            t.phone, t.username, t.password);
            }
            fclose(fp); fclose(temp);
            remove("users.txt");
            rename("temp.txt", "users.txt");
            printf("\nProfile Updated!");
            pressEnter();
        }
        else if (ch == 3) {
            char c;
            printf("Confirm delete (y/n): ");
            scanf(" %c", &c);
            if (c == 'y' || c == 'Y') {
                fp = fopen("users.txt", "r");
                FILE *temp = fopen("temp.txt", "w");
                while (fscanf(fp, "%s %s %s %s %s %s",
                       t.fname, t.lname, t.gmail,
                       t.phone, t.username, t.password) != EOF) {
                    if (strcmp(t.username, currentUser))
                        fprintf(temp, "%s %s %s %s %s %s\n",
                                t.fname, t.lname, t.gmail,
                                t.phone, t.username, t.password);
                }
                fclose(fp); fclose(temp);
                remove("users.txt");
                rename("temp.txt", "users.txt");

                char empFile[40];
                sprintf(empFile, "employees_%s.txt", currentUser);
                remove(empFile);

                clearScreen();
                printf("Thanks for supporting us.\n");
                exit(0);
            }
        }
        else return;
    }
}

// ----------- Payroll Menu -----------

void closeSoftware() {
    clearScreen();
    printf("Thanks for supporting us.\n");
    exit(0);
}

void payrollMenu() {
    int ch;
    while (1) {
        clearScreen();
        printTitle();
        printf("Logged in as: %s\n\n", currentUser);
        printf("1. Show Employees\n");
        printf("2. Add Employee\n");
        printf("3. Search Employee\n");
        printf("4. Create New Payroll\n");
        printf("5. Profile\n");
        printf("6. Logout\n");
        printf("7. Close Software\n");
        printf("Choose: ");
        scanf("%d", &ch);

        if (ch == 1) showEmployees();
        else if (ch == 2) addEmployee();
        else if (ch == 3) searchEmployee();
        else if (ch == 4) createNewPayroll();
        else if (ch == 5) profileMenu();
        else if (ch == 6) return;
        else if (ch == 7) closeSoftware();
    }
}

// ----------- Main -----------

int main() {
    int ch;
    while (1) {
        clearScreen();
        printTitle();
        printf("1. Register\n");
        printf("2. Login\n");
        printf("3. Exit\n");
        printf("Choose: ");
        scanf("%d", &ch);

        if (ch == 1) registerUser();
        else if (ch == 2) {
            if (loginUser()) payrollMenu();
            else {
                printf("\nInvalid login!");
                pressEnter();
            }
        }
        else if (ch == 3) closeSoftware();
    }
}
